/*
 * Copyright 2015 Fizzed Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.fizzed.rocker.compiler;

import com.fizzed.rocker.ContentType;
import java.nio.file.Paths;
import java.util.List;
import org.junit.Assert;
import org.junit.Test;

public class RockerUtilTest {
    
    @Test
    public void pathToPackageName() throws Exception {
        // make sure this works on windows & unix
        Assert.assertEquals("com.fizzed", RockerUtil.pathToPackageName(Paths.get("com", "fizzed")));
    }
    
    @Test
    public void templateNameToName() throws Exception {
        Assert.assertEquals("index_dot_rocker_dot_html", RockerUtil.templateNameToName("index.rocker.html"));
        Assert.assertEquals("index_dot_html", RockerUtil.templateNameToName("index.html"));
        
//        try {
//            RockerUtil.templateNameToName("index");
//            Assert.fail("Exception expected");
//        } catch (IllegalArgumentException e) {
//            // expected
//        }
    }
    
    @Test
    public void templateNameToContentType() throws Exception {
        Assert.assertEquals(ContentType.HTML, RockerUtil.templateNameToContentType("index.rocker.html"));
        Assert.assertEquals(ContentType.RAW, RockerUtil.templateNameToContentType("index.rocker.raw"));
        Assert.assertEquals(ContentType.HTML, RockerUtil.templateNameToContentType("index.html"));
        
        try {
            RockerUtil.templateNameToContentType("index");
            Assert.fail("Exception expected");
        } catch (IllegalArgumentException e) {
            // expected
        }
        
        try {
            RockerUtil.templateNameToContentType("index.unsupported");
            Assert.fail("Exception expected");
        } catch (IllegalArgumentException e) {
            // expected
        }
    }
    
    @Test
    public void chompClosureOpen() {
        Assert.assertEquals("value()", RockerUtil.chompClosureOpen("value()->{"));
        Assert.assertEquals("value()", RockerUtil.chompClosureOpen("value() -> {"));
        Assert.assertEquals("value()", RockerUtil.chompClosureOpen("value()\t\r\n ->\t\n{"));
    }
    
    private String doAppendByteAsJavaByteInitializer(byte b) {
        StringBuilder sb = new StringBuilder();
        RockerUtil.appendByteAsJavaByteInitializer(sb, b);
        return sb.toString();
    }
    
    @Test
    public void appendByteAsJavaByteInitializer() {
        Assert.assertEquals("'j'", doAppendByteAsJavaByteInitializer((byte)'j'));
        Assert.assertEquals("0x00", doAppendByteAsJavaByteInitializer((byte)0x00));
        Assert.assertEquals("(byte)0x80", doAppendByteAsJavaByteInitializer((byte)0x80));
    }
    
    @Test
    public void getTextAsJavaByteArrayInitializer() throws Exception {
        Assert.assertEquals("new byte[] { 'h', 't', 'm', 'l' };", RockerUtil.getTextAsJavaByteArrayInitializer("html", "UTF-8", 4096).get(0));
        Assert.assertEquals("new byte[] { (byte)0xe2, (byte)0x82, (byte)0xac };", RockerUtil.getTextAsJavaByteArrayInitializer("\u20AC", "UTF-8", 4096).get(0));
        
        List<String> byteArrays = RockerUtil.getTextAsJavaByteArrayInitializer("\u20AC", "UTF-8", 1);
        Assert.assertEquals("new byte[] { (byte)0xe2 };", byteArrays.get(0));
        Assert.assertEquals("new byte[] { (byte)0x82 };", byteArrays.get(1));
        Assert.assertEquals("new byte[] { (byte)0xac };", byteArrays.get(2));
    }
    
    @Test
    public void stringIntoChunks() {
        List<String> chunks;
        
        chunks = RockerUtil.stringIntoChunks("sj", 1);
        Assert.assertEquals(2, chunks.size());
        Assert.assertEquals("s", chunks.get(0));
        Assert.assertEquals("j", chunks.get(1));
    }
    
}
